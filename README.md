# 智能设备中生理信号数据压缩

### 具体场景

场景：患者的远程实时监控

场景描述：在远程医疗应用中，患者需要使用智能设备（例如智能手表）实时监测生理信号数据，并将数据发送给医生以便及时发现异常。在这个场景中，智能设备的硬件资源有限，用户需要长时间佩戴设备，进行持续的心电数据采集。

### 项目背景与动机

心电数据在智能设备上采集后，通过无线网络上传到医院服务器，医生可以根据这些数据监控患者的健康状况。但面临如下问题：

1. **存储和带宽限制**：生理信号数据为高频率连续信号，传输未压缩的数据将快速占用带宽，影响其他设备的使用，且会增加传输成本。
2. **电池寿命**：长时间的高频数据采集和传输会耗尽智能设备的电量，患者不得不频繁充电，影响使用体验。
3. **数据精度**：为诊断需要，传输的数据应具备较高保真度，保证能转换为信号图像且医生能够准确解读。

### 项目目标

1. **实现生理信号数据的有效压缩**，开发或优化一种压缩算法，能在传输生理信号时保持数据体积尽可能小，以便适应智能设备的限制和实时传输的需求。
2. **减少智能设备的电池和存储占用**，优化算法复杂度以降低资源消耗。
3. **保持信号的诊断质量**，确保压缩和解压后的信号对医学分析的有效性。

### 限制

1. **带宽限制**：
   - 智能手表或医疗设备通常使用低功耗无线协议（如 BLE 或 Wi-Fi）。这些协议的典型带宽范围为 1-3 MHz，2 MHz 是一个常见的中值。
   - 设定智能手表的无线网络**带宽为 2 MHz**为合理上限，此带宽足以支持基本的生理数据传输需求。
2. **信噪比**：
   - 在实际无线通信环境中，信噪比通常为 10-30 dB，20 dB 为中等质量。
   - 医疗信号需要稳定的传输条件，20 dB 的信噪比保证了数据传输的可靠性，不易丢失或畸变。
   - 设定**信噪比为 20 dB**可以验证压缩算法在常规场景下的性能，而非依赖极佳或极差的传输条件。
3. **数据速率**：
   - 低功耗协议通常限制了数据传输速率。例如 BLE（蓝牙低功耗）的典型传输速率约为 125-500 kbps。
   - 设定**数据速率为 250 kbps**是 BLE 典型上限速率，支持流畅的实时心电传输。
   - 保证压缩算法尽量实现较高的压缩率。例如，假设原始生理信号数据大小为1 MB，压缩后的数据要尽可能小于250 KB，这样可以保在1秒内完成传输（理想情况下）。
4. **延迟要求**：
   - 数据传输的延迟应小于 100 毫秒，以确保用户能实时看到更新的信息。
   - 尽量减少压缩算法的复杂性和执行时间。例如，使用 Huffman编码或其它编码方式，能在较短的时间内处理和压缩数据。
5. **存储限制**：
   - 每次压缩的数据大小不得超过源数据的 60%（或根据具体情况适当调整），以适应智能设备的有限存储空间。

### 可行性与难度分析

1. **技术可行性：**
   - 使用 `pyEDFlib` 等成熟 Python 库可以实现生理信号数据的读取与处理，支持常见的生理信号数据格式 `.edf`。
   - 压缩算法（如熵编码、预测编码）经过广泛应用，在数据压缩方面已有较多研究经验支持。
2. **实现难度：**
   - **数据读取与处理**：Python 库支持 `.edf` 文件的解析，数据预处理的实现难度较低。
   - **压缩算法设计**：需根据信号数据的冗余特性，选择和优化压缩方案，有较多可参考的算法。
   - **压缩算法的限制**：需要符合项目的限制，包括压缩后的数据大小，和压缩算法的复杂度，这个部分实现难度较高。
   - **解压的文件质量**：测试解压后信号数据的质量和完整性，可以通过已有工具实现质量测评，或者通过是否能再次成功将文件转为信号图表。

### 预期成果

1. **压缩算法代码与文档**：实现符合生理信号数据特性的压缩算法，并提供代码和使用文档。
2. **性能与质量报告**：记录制作项目期间尝试过不同压缩方案的性能，包括压缩率、信号质量、传输延迟、功耗消耗等，并选出最优方案。

------



# 实现步骤

### **第 1 步：准备和基础**

#### 1.1 读取工具与数据预处理

我们需要使用生理信号数据的示例文件（如 `.edf` 文件），可以用 `pyEDFlib` 等库加载。

**文件名**: `read_edf_data.py`

为方便操作，将生理信号转换为标准化的数组，并进行可视化。

**文件名**: `preprocess_signal.py`

#### 1.2  熵计算与理论压缩率

我们使用 **熵** 来衡量信号中信息的不确定性，计算信号的最小理论编码长度，并将结果用于评估后续压缩算法的性能。熵是数据压缩的理论下限，越高的熵意味着信号中包含的信息量越多，理论上越难压缩。

**文件名**: `entropy_analysis.py`

**熵计算函数**: `calculate_entropy(signal)`

- **功能**：

  - 将归一化信号量化为 0-255 的整数范围（模拟 8 位采样）。

  - 使用 `Counter` 统计量化值的频率分布。

  - 根据公式计算熵： 
     $$
     H(X) = - \sum_{i=1}^{n} P(x_i) \log_2 P(x_i)
     $$
     其中，P(xᵢ) 是量化值 xᵢ 出现的概率。

- **理论背景**：

  - 熵 H(X) 表示信号中每个符号的平均信息量。

  - 熵值越大，信号的不确定性越高，理论上需要更多位数编码数据。

- **运行结果分析**：

  ```
  Signal Direct_1: Entropy = 6.33 bits per symbol
  Signal Abdomen_1: Entropy = 6.06 bits per symbol
  Signal Abdomen_2: Entropy = 6.17 bits per symbol
  Signal Abdomen_3: Entropy = 6.02 bits per symbol
  Signal Abdomen_4: Entropy = 6.16 bits per symbol
  ```

  - 熵值含义：

    - 熵值 H(X) 表示在无损压缩下，信号中每个符号平均需要的最少位数。

    - 例如，`Direct_1` 信号的熵为 6.33，这意味着理论上每个符号的编码长度至少为 6.33 位。

  - 比较信号复杂度：

    - 不同信号的熵值有所不同，例如 `Direct_1` 的熵（6.33 bits）高于 `Abdomen_3`（6.02 bits）。

    - 熵值较高的信号更复杂，包含更多信息，因此更难压缩。

  - 后续的参考指标：

    - 理论最优压缩比：根据信号熵和采样位数（8 bits）计算： 
      $$
      压缩率 = \frac{\text{熵}}{\text{采样位数}} = \frac{H(X)}{8}
      $$
       例如，`Direct_1` 的理论最优压缩率为 
      $$
      6.33 / 8 \approx 0.79
      $$

    - 这个值是压缩算法的理论上限，实际压缩率不应超过此值。

- **下一步**：

  - 使用熵值计算压缩比的理论上限。

  - 引入香农定理，评估信道传输效率与压缩率之间的关系。

#### 1.3 使用熵值计算压缩比的理论上限

根据熵值和采样位数（8 bits）的关系，理论最优压缩比公式为：
$$
\text{理论压缩比} = \frac{\text{熵}}{\text{采样位数}}
$$
我们扩展 `entropy_analysis.py` 脚本，计算并输出理论最优压缩比。

> 为什么使用 8 bits？
>
> - 在数字信号处理中，8 位量化（即每个采样点用 8 bits 表示）是一种广泛应用的标准格式。
> - 智能设备（如智能手表）通常采用低功耗嵌入式处理器，8 位采样在这些设备中是常用的分辨率，平衡了精度和资源消耗。
> - 对于心电信号等医疗数据，通常以 8 位或 16 位的深度采样：
>   - 8 位采样适合资源受限的设备，用于初步监测。
>   - 16 位采样更适合高精度分析（例如，心电图的诊断级信号）。

**文件名**: `compression_ratio_analysis.py`

- **运行结果分析**：

  ```
  Signal Direct_1: Entropy = 6.33 bits per symbol, Theoretical Compression Ratio = 0.79
  Signal Abdomen_1: Entropy = 6.06 bits per symbol, Theoretical Compression Ratio = 0.76
  Signal Abdomen_2: Entropy = 6.17 bits per symbol, Theoretical Compression Ratio = 0.77
  Signal Abdomen_3: Entropy = 6.02 bits per symbol, Theoretical Compression Ratio = 0.75
  Signal Abdomen_4: Entropy = 6.16 bits per symbol, Theoretical Compression Ratio = 0.77
  ```

  - `Direct_1` 的理论压缩比是 0.79，说明无损压缩后数据大小可以减少到原来的 79%。
  - 理论压缩比为实际压缩的参考上限，后续实现的压缩算法若接近该值，则说明其性能优越。

- **结论**：

  - 熵分析得出了各信号的理论最优压缩比，表明信号有显著的压缩潜力，最优压缩比范围为 0.75 - 0.79。
  - 为后续实际压缩算法性能评估提供了基准。

#### 1.4 引入香农定理，评估信道传输效率与压缩率关系

根据香农定理，信道的最高传输效率由信噪比 SNR 和带宽决定。公式如下：
$$
C = B \cdot \log_2(1 + \text{SNR})
$$
其中：

- C 为信道容量（单位：bps），表示最大传输速率；
- B 为带宽（单位：Hz）；
- SNR 为信噪比（单位：线性值，而非 dB）。

**文件名**: `shannon_capacity_analysis.py`

- **运行结果分析**：

  ```
  Channel Capacity: 13.32 Mbps
  Required Bandwidth for 250.0 kbps: 0.04 MHz
  ```

  - 在 2 MHz 带宽和 20 dB 信噪比下，信道最高传输速率为 13.32 Mbps。
  - 为了传输 250 kbps 数据，在 20 dB 信噪比下，仅需要约 0.04 MHz 的带宽。这表明当前带宽（2 MHz）非常充裕。
  - 当前目标数据速率 250 kbps 远小于信道容量，因此可以通过优化压缩算法进一步减少数据传输量。

#### 1.5 结论

- **信号的压缩潜力（通过熵分析）**

  - **熵分析结果**： 你通过计算信号的熵值，得到了每个信号的理论最优压缩比。熵值高的信号包含的信息量较大，压缩潜力较低；熵值低的信号冗余较多，理论上可以得到更高的压缩比。

  - **压缩比计算**： 通过熵值和采样位数的关系，你得出了每个信号的理论压缩比。这些压缩比反映了你在不丢失信号重要信息的情况下，理论上可以达到的压缩效果。例如：
    - 如果信号 `Direct_1` 的熵为 6.33 bits，那么理论上压缩比为 0.79，即压缩后的数据量约为原始数据量的 79%。
    - 这些理论值为你在设计实际压缩算法时提供了压缩效率的基准。
  - **结论**：你已经知道，信号中存在一定的冗余信息，理论上可以使用压缩算法对其进行有效压缩。基于这些熵值，你可以进一步设计压缩算法（例如，霍夫曼编码、算数编码等），并评估其实际压缩效果。

- **信道容量与数据传输需求（通过香农定理分析）**

  - **信道容量计算**： 根据香农定理，你评估了当前信道的最大传输速率（信道容量）。在给定的带宽（2 MHz）和信噪比（20 dB）下，信道容量为 13.32 Mbps，这远远高于你的目标数据速率（250 kbps）。
  - **带宽需求**： 你还计算了为了满足目标数据传输速率所需的最低带宽。为传输 250 kbps 数据，只需要约 0.04 MHz 带宽，这表明当前的带宽远超实际需求。
  - **结论**：你可以确定，现有的带宽完全能够支持数据传输需求。因此，带宽并不是当前的限制因素，重点应放在如何优化压缩算法，降低数据量，从而提高效率和节省电池。
